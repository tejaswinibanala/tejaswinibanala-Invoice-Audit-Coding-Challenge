# Pharmacy Invoice Audit – Backend

Express + TypeScript service that accepts an uploaded invoice (Excel), fetches a trusted reference drugs list, validates discrepancies, and returns structured results.

## Features

- `POST /api/upload` – multipart Excel upload, parsing with `xlsx`
- Fetches reference data from `https://685daed17b57aebd2af6da54.mockapi.io/api/v1/drugs`
- Discrepancy checks:
  - Unit Price: invoice `unitPrice` > reference `standardUnitPrice` by >10% → overcharge + percentage
  - Formulation: simple normalization; ignores bracketed packaging (e.g., `(10mL)`) and whitespace/case
  - Strength: normalizes units and separators (remove spaces/commas, drop `mg/mcg/iu/units`, normalize slashes)
  - Payer: normalize by removing spaces and lowercasing
- Clear, typed responses with totals and “totalOvercharge”

## Tech Stack

- Node.js, Express, TypeScript
- File Upload: `multer`
- Excel Parsing: `xlsx`
- HTTP Client: `axios` (for reference data)
- Testing: Jest + ts-jest + Supertest

## Getting Started

### Prerequisites
- Node.js 16+
- npm

### Install & Run
```bash
cd invoice-audit-backend
npm install

# Dev (ts-node + nodemon)
npm run dev
# or build + start
npm run build
npm start
# Server runs at http://localhost:3001
```

### Health Check
```http
GET /health → { status: 'ok' }
```

## API

### POST /api/upload
Upload an Excel invoice (`.xlsx`/`.xls`).

- Request: multipart/form-data with field name `invoice`
- Response: `DiscrepancyData` JSON

Example response shape:
```json
{
  "priceDiscrepancies": [{
    "drugName": "...",
    "recordedValue": 1.25,
    "expectedValue": 1.00,
    "discrepancyType": "price",
    "overcharge": 0.25,
    "percentage": 25
  }],
  "formulationDiscrepancies": [...],
  "strengthDiscrepancies": [...],
  "payerDiscrepancies": [...],
  "summary": {
    "totalPriceDiscrepancies": 1,
    "totalFormulationIssues": 0,
    "totalStrengthErrors": 0,
    "totalPayerMismatches": 0,
    "totalIssues": 1,
    "totalOvercharge": 0.25
  }
}
```

## Project Structure

```
src/
├─ index.ts                    # Express bootstrap, routes (/health, /api/upload)
├─ types.ts                    # ReferenceDrug, InvoiceDrug, DrugDiscrepancy, DiscrepancyData
├─ controllers/
│  └─ uploadController.ts      # Orchestrates parse → fetch reference → validate → respond
├─ services/
│  ├─ excelService.ts          # Parses Excel, robust unitPrice parsing, filters invalid rows
│  ├─ referenceService.ts      # Fetches reference drugs via axios
│  └─ validationService.ts     # Normalization + discrepancy logic + summary
└─ __tests__/
   ├─ setup.ts                 # Jest setup (console mocks, timeouts)
   ├─ integration.test.ts      # Supertest integration tests for API
   └─ testDataFactory.ts       # Dynamic test data & edge cases (used by unit tests)
   └─ validationService.test.ts# Unit tests for rules/summary/edge cases
```

## Testing

```bash
# Run all tests
npm test

# Watch mode
npm run test:watch

# Coverage (output in coverage/)
npm run test:coverage
```

- Unit tests cover normalization functions and all rule thresholds.
- Integration tests hit `/api/upload`, including missing-file scenarios.

## Implementation Notes

- Price rule uses `reference.standardUnitPrice` (not `unitPrice`), invoice overage must be >10%.
- Normalize formulation by stripping anything in `(...)`, remove spaces, lowercase.
- Normalize strength by removing spaces/commas, dropping units (`mg|mcg|iu|units?`), lowercasing, and normalizing slashes.
- Normalize payer by removing spaces and lowercasing.
- Summary computes counts and `totalOvercharge` (sum of price discrepancies’ overcharge).

## Operational Notes

- `uploads/` is used by `multer` for temporary file storage at runtime. Keep the directory (git-ignore contents).
- `coverage/` (generated by tests) isn’t required to run the app; safe to delete/ignore.
- `dist/` contains build artifacts after `npm run build`; not needed in source control.

## Troubleshooting

- If `unitPrice` parses as `NaN`: ensure the Excel value is parsed through the sanitizer in `excelService.ts` (strips `$` and `,`, handles numeric cells).
- If no discrepancies appear in tests: ensure invoice/reference drug names match (factories create matching pairs), and the >10% price threshold logic is used.
